let dataTableInstance,passwordUpdateForm=document.getElementById("passwordForm");function fetchProducts(){fetch("/products").then(e=>e.json()).then(e=>{let o=document.getElementById("productsTableBody");o.innerHTML="",dataTableInstance&&dataTableInstance.clear(),e.data.forEach(e=>{var t=[e.name,e.description,e.category,e.price,e.quantity,e.retailer,`<button class="btn btn-primary" onclick="openEditModal('${e._id}')">Edit</button>
                     <button class="btn btn-danger" onclick="deleteProduct('${e._id}')">Delete</button>`];dataTableInstance?dataTableInstance.row.add(t):((t=document.createElement("tr")).innerHTML=`
                        <td>${e.name}</td>
                        <td>${e.description}</td>
                        <td>${e.category}</td>
                        <td>${e.price}</td>
                        <td>${e.quantity}</td>
                        <td>${e.retailer}</td>
                        <td>
                            <button class="btn btn-primary" onclick="openEditModal('${e._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteProduct('${e._id}')">Delete</button>
                        </td>
                    `,o.appendChild(t))}),dataTableInstance?dataTableInstance.draw():dataTableInstance=new DataTable("#productsTable",{paging:!0,searching:!0,ordering:!0,info:!0,pageLength:8})}).catch(e=>console.error("Error loading products:",e))}function openEditModal(t){fetch("/products/"+t).then(e=>e.json()).then(e=>{document.getElementById("productName").value=e.data.name,document.getElementById("productDescription").value=e.data.description,document.getElementById("productCategory").value=e.data.category,document.getElementById("productPrice").value=e.data.price,document.getElementById("productQuantity").value=e.data.quantity,document.getElementById("productRetailer").value=e.data.retailer,document.getElementById("editProductForm").dataset.productId=t,M.updateTextFields(),M.Modal.getInstance(document.getElementById("editProductModal")).open()}).catch(e=>console.error("Error fetching product details:",e))}async function deleteProduct(e){if(confirm("Are you sure you want to delete this product?"))try{(await fetch(`/products/${e}/delete`,{method:"DELETE"})).ok?(alert("Product deleted successfully"),fetchProducts()):alert("Error deleting product")}catch(e){console.error("Error:",e),alert("Error deleting product")}}function fetchOrders(){fetch("/admin/orders").then(e=>e.json()).then(e=>{let s=document.getElementById("ordersTableBody");s.innerHTML="",Array.isArray(e)?(e.forEach(e=>{var t=e.userId?`${e.shippingAddress.street}, ${e.shippingAddress.city}, `+e.shippingAddress.country:"N/A",o=e.userId&&e.userId._id?e.userId.fullName:"N/A",n=e.totalAmount,d=e.status,a=new Date(e.orderedAt).toLocaleDateString(),r=e.shippedAt?new Date(e.shippedAt).toLocaleDateString():"N/A",c=e.deliveredAt?new Date(e.deliveredAt).toLocaleDateString():"N/A";let l="";e.orderItems.forEach(e=>{var t=e.productId?e.productId.name:"Unknown Product",o=e.price,e=e.quantity;l+=`<p>${t} (x${e}) - $${o}</p>`});e=document.createElement("tr");e.innerHTML=`
                        <td>${o}</td>
                        <td>${t}</td>
                        <td>${l}</td>
                        <td>$${n}</td>
                        <td>${d}</td>
                        <td>${a}</td>
                        <td>${r}</td>
                        <td>${c}</td>
                    `,s.appendChild(e)}),$.fn.dataTable.isDataTable("#ordersTable")&&$("#ordersTable").DataTable().destroy(),new DataTable("#ordersTable",{paging:!0,searching:!0,ordering:!0,info:!0,pageLength:8})):console.error("Expected an array of orders, but got:",e)}).catch(e=>console.error("Error loading orders:",e))}async function updateCartCount(){try{var e,t=await(await fetch("/cart/items")).json();t.success&&(e=t.cartItems.reduce((e,t)=>e+t.quantity,0),document.querySelector(".cart-count").textContent=e)}catch(e){console.error("Error updating cart count:",e)}}function adminNav(e,t){for(var o,n=document.getElementsByClassName("tabcontent"),d=0;d<n.length;d++)n[d].style.display="none";for(o=document.getElementsByClassName("tablinks"),tablist=document.getElementsByClassName("sidenav-items")[0].getElementsByTagName("li"),d=0;d<o.length;d++)o[d].classList.remove("active");for(d=0;d<tablist.length;d++)tablist[d].classList.remove("active");document.getElementById(t).style.display="block",e.currentTarget.classList.add("active"),e.currentTarget.closest("li").classList.add("active")}document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("addProductModal"),t=document.getElementById("editProductModal");M.Modal.init(e),M.Modal.init(t);let o=document.getElementById("addProductCategory"),n=document.getElementById("productCategory"),d=document.getElementById("addProductRetailer"),a=document.getElementById("productRetailer");["Technology","Clothing","Food","Home & Garden","Sports & Outdoors","Books","Beauty & Health","Toys & Games","Automotive","Pet Supplies"].forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t.cloneNode(!0)),n.appendChild(t.cloneNode(!0))}),["Amazon","Walmart","Target","Best Buy","Costco","eBay","Newegg","Home Depot","Macy's","PetSmart"].forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,d.appendChild(t.cloneNode(!0)),a.appendChild(t.cloneNode(!0))}),M.FormSelect.init(o),M.FormSelect.init(n),M.FormSelect.init(d),M.FormSelect.init(a);e=document.querySelectorAll("select");M.FormSelect.init(e,{dropdownOptions:{constrainWidth:!0,container:document.body}})}),document.getElementById("addProductBtn").addEventListener("click",function(){document.getElementById("addProductName").value="",document.getElementById("addProductDescription").value="",document.getElementById("addProductCategory").value="",document.getElementById("addProductPrice").value="",document.getElementById("addProductQuantity").value="",document.getElementById("addProductRetailer").value="",M.updateTextFields(),M.Modal.getInstance(document.getElementById("addProductModal")).open()}),document.getElementById("addProductForm").addEventListener("submit",function(e){e.preventDefault();e={name:document.getElementById("addProductName").value,description:document.getElementById("addProductDescription").value,category:document.getElementById("addProductCategory").value,price:parseFloat(document.getElementById("addProductPrice").value),quantity:parseInt(document.getElementById("addProductQuantity").value,10),retailer:document.getElementById("addProductRetailer").value};fetch("/products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>{e.ok?(M.Modal.getInstance(document.getElementById("addProductModal")).close(),fetchProducts()):console.error("Failed to add product")}).catch(e=>console.error("Error adding product:",e))}),document.getElementById("editProductForm").addEventListener("submit",function(e){e.preventDefault();var e=this.dataset.productId,t={name:document.getElementById("productName").value,description:document.getElementById("productDescription").value,category:document.getElementById("productCategory").value,price:parseFloat(document.getElementById("productPrice").value),quantity:parseInt(document.getElementById("productQuantity").value,10),retailer:document.getElementById("productRetailer").value};fetch(`/products/${e}/edit`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>{e.ok?(M.Modal.getInstance(document.getElementById("editProductModal")).close(),fetchProducts()):console.error("Failed to update product")}).catch(e=>console.error("Error updating product:",e))}),passwordUpdateForm?.addEventListener("submit",async t=>{t.preventDefault();var t=document.getElementById("currentPassword").value,e=document.getElementById("newPassword").value;try{var o=await(await fetch("/update-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:t,newPassword:e})})).json(),n=document.querySelector(".status-message");o.success?(n.textContent=o.message,n.style.color="green",document.getElementById("passwordForm").reset()):(n.textContent=o.message||"An error occurred. Please try again.",n.style.color="red"),n.style.display="block"}catch(e){console.error("Error:",e);t=document.querySelector(".status-message");t.textContent="Something went wrong. Please try again.",t.style.color="red",t.style.display="block"}}),window.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("authentication");var t=document.getElementById("register"),o=document.getElementById("login"),n=document.getElementById("logout"),d=document.getElementById("manageProduct"),a=document.getElementById("viewOrder"),r=document.getElementById("forgotPassword"),c=document.getElementById("back-to-sign-in"),l=document.getElementById("footer"),s=document.getElementById("toast__success"),i=document.getElementById("toast_error");let u=document.getElementById("userDropdownButton"),m=document.getElementById("userInfoPopup");document.getElementById("year").textContent=(new Date).getFullYear(),window.addEventListener("load",()=>{let e=document.querySelector(".loader-content");e?(document.body.style.overflow="hidden",setTimeout(()=>{e.style.display="none",document.body.style.overflow="auto"},2e3)):document.body.style.overflow="auto"}),null===s&&null===i||(s?M.toast({html:s.getAttribute("data-message"),classes:"toast toast__success",displayLength:4e3}):M.toast({html:i.getAttribute("data-message"),classes:"toast toast__error",displayLength:4e3}));s=window.location.pathname;"/"!==s&&"/dashboard"!==s||(l.style.display="none"),"/dashboard"===s&&(d.addEventListener("click",fetchProducts),a.addEventListener("click",fetchOrders)),t?.addEventListener("click",()=>{e.classList.add("active")}),o?.addEventListener("click",()=>{e.classList.remove("active")}),n?.addEventListener("click",()=>{fetch("/logout",{method:"POST",credentials:"include"}).then(e=>{e.ok&&(window.location.href="/")}).catch(e=>{console.error("Error logging out:",e)})}),r?.addEventListener("click",e=>{e.preventDefault(),document.getElementById("sign-in-form").style.display="none",document.getElementById("forgot-password-container").style.display="block"}),c?.addEventListener("click",e=>{e.preventDefault(),document.getElementById("sign-in-form").style.display="block",document.getElementById("forgot-password-container").style.display="none"}),u&&m&&document.addEventListener("click",e=>{e.target===u?(e.preventDefault(),m.classList.toggle("active")):m.contains(e.target)||m.classList.remove("active")})});let notifications=[];function updateNotifications(e){console.log("Updating notifications with:",e),notifications.unshift(e);var t=document.querySelector(".notification-count"),t=(t&&(t.textContent=notifications.length),document.getElementById("notifications-dropdown"));t&&(t.innerHTML=notifications.map(e=>`
                    <li>
                        <a href="#!" class="notification-item">
                            <span class="notification-message">${e.message}</span>
                            <span class="notification-time">${new Date(e.timestamp).toLocaleTimeString()}</span>
                        </a>
                    </li>
                `).join("")),M&&M.toast&&M.toast({html:e.message})}let socket=io();socket.on("connect",()=>{console.log("Connected to socket server")}),socket.on("connect_error",e=>{console.error("Socket connection error:",e)}),socket.on("notification",e=>{console.log("Received notification:",e),updateNotifications(e)});