let dataTableInstance,passwordUpdateForm=document.getElementById("passwordForm"),addProductBtn=document.getElementById("addProductBtn"),addProductForm=document.getElementById("addProductForm"),editProductForm=document.getElementById("editProductForm");function fetchProducts(){fetch("/products").then(e=>e.json()).then(e=>{let o=document.getElementById("productsTableBody");o.innerHTML="",dataTableInstance&&dataTableInstance.clear(),e.data.forEach(e=>{var t=[e.name,e.description,e.category,e.price,e.quantity,e.retailer,`<button class="btn btn-primary" onclick="openEditModal('${e._id}')">Edit</button>
                     <button class="btn btn-danger" onclick="deleteProduct('${e._id}')">Delete</button>`];dataTableInstance?dataTableInstance.row.add(t):((t=document.createElement("tr")).innerHTML=`
                        <td>${e.name}</td>
                        <td>${e.description}</td>
                        <td>${e.category}</td>
                        <td>${e.price}</td>
                        <td>${e.quantity}</td>
                        <td>${e.retailer}</td>
                        <td>
                            <button class="btn btn-primary" onclick="openEditModal('${e._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteProduct('${e._id}')">Delete</button>
                        </td>
                    `,o.appendChild(t))}),dataTableInstance?dataTableInstance.draw():dataTableInstance=new DataTable("#productsTable",{paging:!0,searching:!0,ordering:!0,info:!0,pageLength:8})}).catch(e=>console.error("Error loading products:",e))}function adminModal(e,t){var o=document.getElementById("addProductModal"),d=document.getElementById("editProductModal");M.Modal.init(o),M.Modal.init(d);let n=document.getElementById("addProductCategory"),a=document.getElementById("productCategory"),r=document.getElementById("addProductRetailer"),c=document.getElementById("productRetailer");e.forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,n.appendChild(t.cloneNode(!0)),a.appendChild(t.cloneNode(!0))}),t.forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t.cloneNode(!0)),c.appendChild(t.cloneNode(!0))}),M.FormSelect.init(n),M.FormSelect.init(a),M.FormSelect.init(r),M.FormSelect.init(c);o=document.querySelectorAll("select");M.FormSelect.init(o,{dropdownOptions:{constrainWidth:!0,container:document.body}})}function openEditModal(t){fetch("/products/"+t).then(e=>e.json()).then(e=>{document.getElementById("productName").value=e.data.name,document.getElementById("productDescription").value=e.data.description,document.getElementById("productCategory").value=e.data.category,document.getElementById("productPrice").value=e.data.price,document.getElementById("productQuantity").value=e.data.quantity,document.getElementById("productRetailer").value=e.data.retailer,document.getElementById("editProductForm").dataset.productId=t,M.updateTextFields(),M.Modal.getInstance(document.getElementById("editProductModal")).open()}).catch(e=>console.error("Error fetching product details:",e))}async function deleteProduct(e){if(confirm("Are you sure you want to delete this product?"))try{(await fetch(`/products/${e}/delete`,{method:"DELETE"})).ok?(showToast("Product deleted successfully"),fetchProducts()):showToast("Error deleting product")}catch(e){console.error("Error:",e),showToast("Error deleting product")}}function fetchOrders(){fetch("/admin/orders").then(e=>e.json()).then(e=>{let l=document.getElementById("ordersTableBody");l.innerHTML="",Array.isArray(e)?(e.forEach(e=>{var t=e.userId?`${e.shippingAddress.street}, ${e.shippingAddress.city}, `+e.shippingAddress.country:"N/A",o=e.userId&&e.userId._id?e.userId.fullName:"N/A",d=e.totalAmount,n=e.status,a=new Date(e.orderedAt).toLocaleDateString(),r=e.shippedAt?new Date(e.shippedAt).toLocaleDateString():"N/A",c=e.deliveredAt?new Date(e.deliveredAt).toLocaleDateString():"N/A";let s="";e.orderItems.forEach(e=>{var t=e.productId?e.productId.name:"Unknown Product",o=e.price,e=e.quantity;s+=`<p>${t} (x${e}) - $${o}</p>`});e=document.createElement("tr");e.innerHTML=`
                        <td>${o}</td>
                        <td>${t}</td>
                        <td>${s}</td>
                        <td>$${d}</td>
                        <td>${n}</td>
                        <td>${a}</td>
                        <td>${r}</td>
                        <td>${c}</td>
                    `,l.appendChild(e)}),$.fn.dataTable.isDataTable("#ordersTable")&&$("#ordersTable").DataTable().destroy(),new DataTable("#ordersTable",{paging:!0,searching:!0,ordering:!0,info:!0,pageLength:8})):console.error("Expected an array of orders, but got:",e)}).catch(e=>console.error("Error loading orders:",e))}async function updateCartCount(){try{var e,t=await(await fetch("/cart/items")).json();t.success&&(e=t.cartItems.reduce((e,t)=>e+t.quantity,0),document.querySelector(".cart-count").textContent=e)}catch(e){console.error("Error updating cart count:",e)}}function adminNav(e,t){for(var o,d=document.getElementsByClassName("tabcontent"),n=0;n<d.length;n++)d[n].style.display="none";for(o=document.getElementsByClassName("tablinks"),tablist=document.getElementsByClassName("sidenav-items")[0].getElementsByTagName("li"),n=0;n<o.length;n++)o[n].classList.remove("active");for(n=0;n<tablist.length;n++)tablist[n].classList.remove("active");document.getElementById(t).style.display="block",e.currentTarget.classList.add("active"),e.currentTarget.closest("li").classList.add("active")}function showToast(e){M&&M.toast?M.toast({html:e}):console.error("Materialize is not loaded.")}addProductBtn?.addEventListener("click",function(){document.getElementById("addProductName").value="",document.getElementById("addProductDescription").value="",document.getElementById("addProductCategory").value="",document.getElementById("addProductPrice").value="",document.getElementById("addProductQuantity").value="",document.getElementById("addProductRetailer").value="",M.updateTextFields(),M.Modal.getInstance(document.getElementById("addProductModal")).open()}),addProductForm?.addEventListener("submit",function(e){e.preventDefault();e={name:document.getElementById("addProductName").value,description:document.getElementById("addProductDescription").value,category:document.getElementById("addProductCategory").value,price:parseFloat(document.getElementById("addProductPrice").value),quantity:parseInt(document.getElementById("addProductQuantity").value,10),retailer:document.getElementById("addProductRetailer").value};fetch("/products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.json()).then(e=>{e.success?(M.Modal.getInstance(document.getElementById("addProductModal")).close(),showToast("Product added successfully"),fetchProducts()):(showToast("Failed to add product"),console.error("Failed to add product"))}).catch(e=>{showToast("There was an error adding the product"),console.error("Error adding product:",e)})}),editProductForm?.addEventListener("submit",function(e){e.preventDefault();var e=this.dataset.productId,t={name:document.getElementById("productName").value,description:document.getElementById("productDescription").value,category:document.getElementById("productCategory").value,price:parseFloat(document.getElementById("productPrice").value),quantity:parseInt(document.getElementById("productQuantity").value,10),retailer:document.getElementById("productRetailer").value};fetch(`/products/${e}/edit`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{e.success?(M.Modal.getInstance(document.getElementById("editProductModal")).close(),showToast("Product updated successfully"),fetchProducts()):(showToast("Failed to update product"),console.error("Failed to update product"))}).catch(e=>{showToast("There was an error updating the product"),console.error("Error updating product:",e)})}),passwordUpdateForm?.addEventListener("submit",async t=>{t.preventDefault();var t=document.getElementById("currentPassword").value,e=document.getElementById("newPassword").value;try{var o=await(await fetch("/update-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:t,newPassword:e})})).json(),d=document.querySelector(".status-message");o.success?(d.textContent=o.message,d.style.color="green",document.getElementById("passwordForm").reset()):(d.textContent=o.message||"An error occurred. Please try again.",d.style.color="red"),d.style.display="block"}catch(e){console.error("Error:",e);t=document.querySelector(".status-message");t.textContent="Something went wrong. Please try again.",t.style.color="red",t.style.display="block"}}),window.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("authentication");var t=document.getElementById("register"),o=document.getElementById("login"),d=document.getElementById("logout"),n=document.getElementById("manageProduct"),a=document.getElementById("viewOrder"),r=document.getElementById("forgotPassword"),c=document.getElementById("back-to-sign-in"),s=document.getElementById("footer"),l=document.getElementById("toast__success"),i=document.getElementById("toast_error");let u=document.getElementById("userDropdownButton"),m=document.getElementById("userInfoPopup");var i=l||i,i=(document.getElementById("year").textContent=(new Date).getFullYear(),window.addEventListener("load",()=>{let e=document.querySelector(".loader-content");e?(document.body.style.overflow="hidden",setTimeout(()=>{e.style.display="none",document.body.style.overflow="auto"},2e3)):document.body.style.overflow="auto"}),null!==i&&(i=i.getAttribute("data-message"),M.toast({html:i,classes:"toast "+(l?"toast__success":"toast__error"),displayLength:4e3})),window.location.pathname);"/"!==i&&"/dashboard"!==i||(s.style.display="none"),"/dashboard"===i&&(n.addEventListener("click",fetchProducts),a.addEventListener("click",fetchOrders),adminModal(["Technology","Clothing","Food","Home & Garden","Sports & Outdoors","Books","Beauty & Health","Toys & Games","Automotive","Pet Supplies"],["Amazon","Walmart","Target","Best Buy","Costco","eBay","Newegg","Home Depot","Macy's","PetSmart"])),t?.addEventListener("click",()=>{e.classList.add("active")}),o?.addEventListener("click",()=>{e.classList.remove("active")}),d?.addEventListener("click",()=>{fetch("/logout",{method:"POST",credentials:"include"}).then(e=>{e.ok&&(window.location.href="/")}).catch(e=>{console.error("Error logging out:",e)})}),r?.addEventListener("click",e=>{e.preventDefault(),document.getElementById("sign-in-form").style.display="none",document.getElementById("forgot-password-container").style.display="block"}),c?.addEventListener("click",e=>{e.preventDefault(),document.getElementById("sign-in-form").style.display="block",document.getElementById("forgot-password-container").style.display="none"}),u&&m&&document.addEventListener("click",e=>{e.target===u?(e.preventDefault(),m.classList.toggle("active")):m.contains(e.target)||m.classList.remove("active")})});let notifications=[];function updateNotifications(e){console.log("Updating notifications with:",e),notifications.unshift(e);var t=document.querySelector(".notification-count"),t=(t&&(t.textContent=notifications.length),document.getElementById("notifications-dropdown"));t&&(t.innerHTML=notifications.map(e=>`
                    <li>
                        <a href="#!" class="notification-item">
                            <span class="notification-message">${e.message}</span>
                            <span class="notification-time">${new Date(e.timestamp).toLocaleTimeString()}</span>
                        </a>
                    </li>
                `).join("")),showToast(e.message)}let socket=io();socket.on("connect",()=>{console.log("Connected to socket server")}),socket.on("connect_error",e=>{console.error("Socket connection error:",e)}),socket.on("notification",e=>{console.log("Received notification:",e),updateNotifications(e)});