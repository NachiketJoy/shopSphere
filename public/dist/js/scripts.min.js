let dataTableInstance,passwordUpdateForm=document.getElementById("passwordForm"),addProductBtn=document.getElementById("addProductBtn"),addProductForm=document.getElementById("addProductForm"),editProductForm=document.getElementById("editProductForm");function adminFetchProducts(){fetch("/products").then(t=>t.json()).then(t=>{let a=document.getElementById("productsTableBody");a.innerHTML="",dataTableInstance&&dataTableInstance.clear(),t.data.forEach(t=>{var e=[t.name,t.description,t.category,t.price,t.discountedPrice,t.quantity,t.retailer,`<button class="btn btn-primary" onclick="openEditModal('${t._id}')">Edit</button>
                     <button class="btn btn-danger" onclick="deleteProduct('${t._id}')">Delete</button>`];dataTableInstance?dataTableInstance.row.add(e):((e=document.createElement("tr")).innerHTML=`
                        <td>${t.name}</td>
                        <td>${t.description}</td>
                        <td>${t.category}</td>
                        <td>${t.price}</td>
                        <td>${t.discountedPrice}</td>
                        <td>${t.quantity}</td>
                        <td>${t.retailer}</td>
                        <td>
                            <button class="btn btn-primary" onclick="openEditModal('${t._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteProduct('${t._id}')">Delete</button>
                        </td>
                    `,a.appendChild(e))}),dataTableInstance?dataTableInstance.draw():dataTableInstance=new DataTable("#productsTable",{paging:!0,searching:!0,ordering:!0,info:!0,pageLength:8})}).catch(t=>console.error("Error loading products:",t))}function adminModal(t,e){var a=document.getElementById("addProductModal"),o=document.getElementById("editProductModal");M.Modal.init(a),M.Modal.init(o);let d=document.getElementById("addProductCategory"),n=document.getElementById("productCategory"),c=document.getElementById("addProductRetailer"),r=document.getElementById("productRetailer");t.forEach(t=>{var e=document.createElement("option");e.value=t,e.textContent=t,d.appendChild(e.cloneNode(!0)),n.appendChild(e.cloneNode(!0))}),e.forEach(t=>{var e=document.createElement("option");e.value=t,e.textContent=t,c.appendChild(e.cloneNode(!0)),r.appendChild(e.cloneNode(!0))}),M.FormSelect.init(d),M.FormSelect.init(n),M.FormSelect.init(c),M.FormSelect.init(r);a=document.querySelectorAll("select");M.FormSelect.init(a,{dropdownOptions:{constrainWidth:!0,container:document.body}})}function openEditModal(e){fetch("/products/"+e).then(t=>t.json()).then(t=>{document.getElementById("productName").value=t.data.name,document.getElementById("productDescription").value=t.data.description,document.getElementById("productCategory").value=t.data.category,document.getElementById("productPrice").value=t.data.price,document.getElementById("discountedProductPrice").value=t.data.discountedPrice,document.getElementById("productQuantity").value=t.data.quantity,document.getElementById("productRetailer").value=t.data.retailer,document.getElementById("editProductForm").dataset.productId=e,M.updateTextFields(),M.Modal.getInstance(document.getElementById("editProductModal")).open()}).catch(t=>console.error("Error fetching product details:",t))}async function deleteProduct(t){if(confirm("Are you sure you want to delete this product?"))try{(await fetch(`/products/${t}/delete`,{method:"DELETE"})).ok?(showToast("Product deleted successfully"),adminFetchProducts()):showToast("Error deleting product")}catch(t){console.error("Error:",t),showToast("Error deleting product")}}function fetchOrders(){fetch("/admin/orders").then(t=>t.json()).then(t=>{let s=document.getElementById("ordersTableBody");s.innerHTML="",Array.isArray(t)?(t.forEach(t=>{var e=t.userId?`${t.shippingAddress.street}, ${t.shippingAddress.city}, `+t.shippingAddress.country:"N/A",a=t.userId&&t.userId._id?t.userId.fullName:"N/A",o=t.totalAmount,d=t.status,n=new Date(t.orderedAt).toLocaleDateString(),c=t.shippedAt?new Date(t.shippedAt).toLocaleDateString():"N/A",r=t.deliveredAt?new Date(t.deliveredAt).toLocaleDateString():"N/A";let i="";t.orderItems.forEach(t=>{var e=t.productId?t.productId.name:"Unknown Product",a=t.price,t=t.quantity;i+=`<p>${e} (x${t}) - $${a}</p>`});t=document.createElement("tr");t.innerHTML=`
                        <td>${a}</td>
                        <td>${e}</td>
                        <td>${i}</td>
                        <td>$${o}</td>
                        <td>${d}</td>
                        <td>${n}</td>
                        <td>${c}</td>
                        <td>${r}</td>
                    `,s.appendChild(t)}),$.fn.dataTable.isDataTable("#ordersTable")&&$("#ordersTable").DataTable().destroy(),new DataTable("#ordersTable",{paging:!0,searching:!0,ordering:!0,info:!0,pageLength:8})):console.error("Expected an array of orders, but got:",t)}).catch(t=>console.error("Error loading orders:",t))}addProductBtn?.addEventListener("click",function(){document.getElementById("addProductName").value="",document.getElementById("addProductDescription").value="",document.getElementById("addProductCategory").value="",document.getElementById("addProductPrice").value="",document.getElementById("addProductQuantity").value="",document.getElementById("addProductRetailer").value="",M.updateTextFields(),M.Modal.getInstance(document.getElementById("addProductModal")).open()}),addProductForm?.addEventListener("submit",function(t){t.preventDefault();t={name:document.getElementById("addProductName").value,description:document.getElementById("addProductDescription").value,category:document.getElementById("addProductCategory").value,price:parseFloat(document.getElementById("addProductPrice").value),quantity:parseInt(document.getElementById("addProductQuantity").value,10),retailer:document.getElementById("addProductRetailer").value};fetch("/products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(t=>t.json()).then(t=>{t.success?(M.Modal.getInstance(document.getElementById("addProductModal")).close(),showToast("Product added successfully"),adminFetchProducts()):(showToast("Failed to add product"),console.error("Failed to add product"))}).catch(t=>{showToast("There was an error adding the product"),console.error("Error adding product:",t)})}),editProductForm?.addEventListener("submit",function(t){t.preventDefault();var t=this.dataset.productId,e={name:document.getElementById("productName").value,description:document.getElementById("productDescription").value,category:document.getElementById("productCategory").value,price:parseFloat(document.getElementById("productPrice").value),discountedPrice:parseFloat(document.getElementById("discountedProductPrice").value),quantity:parseInt(document.getElementById("productQuantity").value,10),retailer:document.getElementById("productRetailer").value};fetch(`/products/${t}/edit`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(t=>t.json()).then(t=>{t.success?(t.data.discountedPrice<t.data.price&&showToast("Big Promo on "+t.data.name),t.data.quantity<=2&&showToast("not much in stock"),M.Modal.getInstance(document.getElementById("editProductModal")).close(),showToast("Product updated successfully"),adminFetchProducts()):(showToast("Failed to update product"),console.error("Failed to update product"))}).catch(t=>{showToast("There was an error updating the product"),console.error("Error updating product:",t)})}),passwordUpdateForm?.addEventListener("submit",async t=>{t.preventDefault();var t=document.getElementById("currentPassword").value,e=document.getElementById("newPassword").value,a=document.getElementById("error"),o=[];if(!/^(?=.*[!@#$%^&*])[\S]{8,}$/.test(e.value))return o.push("Password should be at least 8 characters and contain at least 1 special character (!@#$%^&*)."),a.innerText=o.join(", "),e.focus(),!1;try{var d=await(await fetch("/update-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:t,newPassword:e})})).json(),n=document.querySelector(".status-message");d.success?(n.textContent=d.message,n.style.color="green",document.getElementById("passwordForm").reset()):(n.textContent=d.message||"An error occurred. Please try again.",n.style.color="red"),n.style.display="block"}catch(t){console.error("Error:",t);a=document.querySelector(".status-message");a.textContent="Something went wrong. Please try again.",a.style.color="red",a.style.display="block"}});let checkoutForm=document.getElementById("checkoutForm");async function loadCart(){try{var t=await(await fetch("/cart/items")).json();t.success&&(displayCartItems(t.cartItems),updateCartTotal(t.cartItems))}catch(t){M.toast({html:"Error loading cart items"})}}function displayCartItems(t){var e=document.getElementById("cartItems");0===t.length?e.innerHTML="<p>Your cart is empty</p>":(document.getElementById("checkoutBtn").disabled=0===t.length,e.innerHTML=t.map(t=>`
        <div class="cart-item" data-id="${t._id}">
        <img src="${t.productId.image||"https://placehold.co/100x100"}" alt="${t.productId.name}">
        <div class="item-details">
            <h5>${t.productId.name}</h5>
            <p>Retailer: ${t.productId.retailer}</p>
            <p>Price: $${t.productId.price}</p>
            <div class="quantity-controls">
            <button class="btn-small" onclick="updateQuantity('${t._id}', ${t.quantity-1})">-</button>
            <span>${t.quantity}</span>
            <button class="btn-small" onclick="updateQuantity('${t._id}', ${t.quantity+1})">+</button>
            </div>
            <button class="btn-small red" onclick="removeItem('${t._id}')">Remove</button>
        </div>
        </div>
    `).join(""))}async function updateQuantity(t,e){e<1||(await fetch("/cart/update/"+t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({quantity:e})})).ok&&(loadCart(),updateCartCount())}async function removeItem(t){(await fetch("/cart/delete/"+t,{method:"DELETE"})).ok&&(loadCart(),updateCartCount())}async function clearCart(){(await fetch("/cart/clear",{method:"DELETE"})).ok&&(loadCart(),updateCartCount())}function updateCartTotal(t){t=t.reduce((t,e)=>t+e.productId.price*e.quantity,0);document.getElementById("cartTotal").textContent=t.toFixed(2)}function checkout(){window.location.href="/checkout"}async function loadCheckoutItems(){try{var t=await(await fetch("/cart/items")).json();t.success&&(displayCheckoutItems(t.cartItems),updateTotalAmount(t.cartItems))}catch(t){M.toast({html:"Error loading cart items"})}}function displayCheckoutItems(t){document.getElementById("checkoutItems").innerHTML=t.map(t=>`
            <div class="checkout-item">
                <div class="item-info">
                    <img src="${t.productId.image||"https://placehold.co/100x100"}" alt="${t.productId.name}">
                    <div class="item-details">
                        <h6>${t.productId.name}</h6>
                        <p>Quantity: ${t.quantity}</p>
                        <p>Price: $${t.productId.price}</p>
                    </div>
                </div>
                <div class="item-total">
                    $${(t.productId.price*t.quantity).toFixed(2)}
                </div>
            </div>
        `).join("")}function updateTotalAmount(t){t=t.reduce((t,e)=>t+e.productId.price*e.quantity,0);document.getElementById("totalAmount").textContent=t.toFixed(2)}async function updateCartCount(){try{var t,e=await(await fetch("/cart/items")).json(),a=document.querySelector(".cart-count");e.success&&(t=e.cartItems.reduce((t,e)=>t+e.quantity,0),a)&&(a.textContent=t)}catch(t){console.error("Error updating cart count:",t)}}function adminNav(t,e){for(var a,o=document.getElementsByClassName("tabcontent"),d=0;d<o.length;d++)o[d].style.display="none";for(a=document.getElementsByClassName("tablinks"),tablist=document.getElementsByClassName("sidenav-items")[0].getElementsByTagName("li"),d=0;d<a.length;d++)a[d].classList.remove("active");for(d=0;d<tablist.length;d++)tablist[d].classList.remove("active");document.getElementById(e).style.display="block",t.currentTarget.classList.add("active"),t.currentTarget.closest("li").classList.add("active")}function showToast(t){M&&M.toast?M.toast({html:t}):console.error("Materialize is not loaded.")}checkoutForm?.addEventListener("submit",async t=>{t.preventDefault();t={cardNumber:document.getElementById("cardNumber").value,expiryDate:document.getElementById("expiryDate").value,cvv:document.getElementById("cvv").value,shippingAddress:{street:document.getElementById("street").value,city:document.getElementById("city").value,postalCode:document.getElementById("postalCode").value,country:document.getElementById("country").value}};try{var e=await(await fetch("/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();e.success&&(io("/order/"+e.order._id).on("statusUpdate",t=>{M.toast({html:"Order status: "+t.status}),updateNotifications(t)}),window.location.href="/homepage")}catch(t){M.toast({html:"Error creating order"})}}),window.addEventListener("load",()=>{let t=document.querySelector(".loader-content");t?(document.body.style.overflow="hidden",setTimeout(()=>{t.style.display="none",document.body.style.overflow="auto"},2e3)):document.body.style.overflow="auto"}),window.addEventListener("DOMContentLoaded",()=>{let t=document.getElementById("authentication");var e=document.getElementById("register"),a=document.getElementById("login"),o=document.getElementById("logout"),d=document.getElementById("manageProduct"),n=document.getElementById("viewOrder"),c=document.getElementById("forgotPassword"),r=document.getElementById("back-to-sign-in"),i=document.getElementById("footer"),s=document.getElementById("toast__success"),l=document.getElementById("toast_error");let u=document.getElementById("userDropdownButton"),m=document.getElementById("userInfoPopup");var p=document.getElementById("searchForm"),g=document.getElementById("year"),y=document.getElementById("detailProductModal"),h=(M.Modal.init(y),window.location.pathname),y=s||l;g.textContent=(new Date).getFullYear(),updateCartCount();switch(null!==y&&(l=y.getAttribute("data-message"),M.toast({html:l,classes:"toast "+(s?"toast__success":"toast__error"),displayLength:4e3})),h){case"/":case"/dashboard":i.style.display="none","/dashboard"===h&&(d.addEventListener("click",adminFetchProducts),n.addEventListener("click",fetchOrders),adminModal(["Technology","Clothing","Food","Home & Garden","Sports & Outdoors","Books","Beauty & Health","Toys & Games","Automotive","Pet Supplies"],["Amazon","Walmart","Target","Best Buy","Costco","eBay","Newegg","Home Depot","Macy's","PetSmart"]));break;case"/homepage":fetchProducts();break;case"/cart":loadCart();break;case"/checkout":loadCheckoutItems()}e?.addEventListener("click",()=>{t.classList.add("active")}),a?.addEventListener("click",()=>{t.classList.remove("active")}),o?.addEventListener("click",()=>{fetch("/logout",{method:"POST",credentials:"include"}).then(t=>{t.ok&&(window.location.href="/")}).catch(t=>{console.error("Error logging out:",t)})}),c?.addEventListener("click",t=>{t.preventDefault(),document.getElementById("sign-in-form").style.display="none",document.getElementById("forgot-password-container").style.display="block"}),r?.addEventListener("click",t=>{t.preventDefault(),document.getElementById("sign-in-form").style.display="block",document.getElementById("forgot-password-container").style.display="none"}),p?.addEventListener("submit",t=>{t.preventDefault(),fetchProducts()});g=document.querySelectorAll("select");M.FormSelect.init(g),u&&m&&document.addEventListener("click",t=>{t.target===u?(t.preventDefault(),m.classList.toggle("active")):m.contains(t.target)||m.classList.remove("active")})});let productsList=[];async function fetchProducts(t=1){try{var e=document.getElementById("search").value,a=document.getElementById("retailer").value,o=document.getElementById("sortBy").value,d=document.getElementById("order").value,n=new URLSearchParams({search:e,retailer:a,sortBy:o,order:d,page:t,limit:12}),c=await(await fetch("/products?"+n)).json();c.success?(displayProducts(productsList=c.data),displayPagination(c.pagination)):M.toast({html:"Error loading products"})}catch(t){console.error("Error:",t),M.toast({html:"Error loading products"})}}function displayProducts(t){document.getElementById("productsContainer").innerHTML=t.map(t=>0!=t.quantity?`
            <div class="col s12 m6 l4">
                <div class="card" onclick="showProductDetails('${t._id}')">
                <div class="card-image">
                    <img src="${t.image||`https://placehold.co/400x400?text=IMG:${t.name}&font=playfair-display`}">
                    <span class="card-title">${t.name}</span>
                    <a class="btn-floating halfway-fab waves-effect waves-light red" onclick="addToCart('${t._id}')">
                    <i class="add_button">Add</i>
                    </a>
                </div>
                <div class="card-content">
                    <p class="price">Price: $${t.price}</p>
                    <p class="quantity">Quantity: ${t.quantity}</p>
                    <p>${t.description}</p>
                    <p class="retailer">Retailer: ${t.retailer}</p>
                </div>
                </div>
            </div> `:`
                <div>
                 <p> No product found </p>
                </div>
                `).join("")}function displayPagination(a){if(a){var t=document.getElementById("pagination");let e=`
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
          `;e=(e+='<ul class="pagination">')+`
            <li class="${1===a.currentPage?"disabled":""}">
              <a href="#!" onclick="${1<a.currentPage?`fetchProducts(${a.currentPage-1})`:""}">
                <i class="fas fa-chevron-left"></i>
              </a>
            </li>
          `;var o=Math.max(1,a.currentPage-Math.floor(2.5)),d=Math.min(a.totalPages,o+5-1);for(let t=o;t<=d;t++)e+=`
              <li class="${a.currentPage===t?"active":""}">
                <a href="#!" onclick="fetchProducts(${t})">${t}</a>
              </li>
            `;d<a.totalPages&&(e+=`
              <li class="disabled">
                <a href="#!">...</a>
              </li>
              <li>
                <a href="#!" onclick="fetchProducts(${a.totalPages})">${a.totalPages}</a>
              </li>
            `),e=(e=e+`
            <li class="${a.currentPage===a.totalPages?"disabled":""}">
              <a href="#!" onclick="${a.currentPage<a.totalPages?`fetchProducts(${a.currentPage+1})`:""}">
                <i class="fas fa-chevron-right"></i>
              </a>
            </li>
          `+"</ul>")+`
            <div class="pagination-jump">
              <label for="jumpPage">Go to page:</label>
              <input type="number" id="jumpPage" min="1" max="${a.totalPages}" value="${a.currentPage}">
              <button onclick="jumpToPage(${a.totalPages})">Go</button>
            </div>
          `+"</div>",t.innerHTML=e}}function jumpToPage(t){var e=document.getElementById("jumpPage"),e=parseInt(e.value,10);!isNaN(e)&&1<=e&&e<=t?fetchProducts(e):showToast("Please enter a valid page number.")}async function addToCart(t){try{(await(await fetch("/cart/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productId:t})})).json()).success?(M.toast({html:"Item added to cart"}),updateCartCount()):M.toast({html:"Cannot add more"})}catch(t){M.toast({html:"Error adding item to cart"})}}function showProductDetails(e){let a=productsList.find(t=>t._id===e);var t=document.getElementById("productName"),o=document.getElementById("productCategory"),d=document.getElementById("productPrice"),n=document.getElementById("productDesc"),c=document.getElementById("similarProductsContainer");let r=document.getElementById("productImageCarousel");a?(t.innerText=a.name,o.innerText=a.category,d.innerText=a.price,n.innerText=a.description,r.innerHTML="",a.images.forEach(t=>{var e=document.createElement("a");e.classList.add("carousel-item"),e.href="#",e.innerHTML=`<img src="${t}" alt="${a.name}">`,r.appendChild(e)}),setTimeout(()=>{M.Carousel.init(r,{fullWidth:!1,indicators:!0}).set(1)},100),t=productsList.filter(t=>t.category===a.category&&t._id!==e).slice(0,5),c.innerHTML=t.map(t=>`
        <div class="similar-product" onclick="showProductDetails('${t._id}')">
            <img src="${t.image||"https://placehold.co/100x100"}" alt="${t.name}">
            <p>${t.name}</p>
        </div>
    `).join(""),M.Modal.getInstance(document.getElementById("detailProductModal")).open()):M.toast({html:"Product not found!"})}let notifications=[];function updateNotifications(t){console.log("Updating notifications with:",t),notifications.unshift(t);var e=document.querySelector(".notification-count"),e=(e&&(e.textContent=notifications.length),document.getElementById("notifications-dropdown"));e&&(e.innerHTML=notifications.map(t=>`
                    <li>
                        <a href="#!" class="notification-item">
                            <span class="notification-message">${t.message}</span>
                            <span class="notification-time">${new Date(t.timestamp).toLocaleTimeString()}</span>
                        </a>
                    </li>
                `).join("")),showToast(t.message)}let socket=io();socket.on("connect",()=>{console.log("Connected to socket server")}),socket.on("connect_error",t=>{console.error("Socket connection error:",t)}),socket.on("notification",t=>{console.log("Received notification:",t),updateNotifications(t)});