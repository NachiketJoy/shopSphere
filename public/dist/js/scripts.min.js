let dataTableInstance,passwordUpdateForm=document.getElementById("passwordForm");function fetchProducts(){fetch("/products").then(e=>e.json()).then(e=>{let n=document.getElementById("productsTableBody");n.innerHTML="",dataTableInstance&&dataTableInstance.clear(),e.data.forEach(e=>{var t=[e.name,e.description,e.category,e.price,e.quantity,e.retailer,`<a href="/products/${e._id}/edit" class="btn btn-primary">Edit</a>
                     <button class="btn btn-danger" onclick="deleteProduct('${e._id}')">Delete</button>`];dataTableInstance?dataTableInstance.row.add(t):((t=document.createElement("tr")).innerHTML=`
                        <td>${e.name}</td>
                        <td>${e.description}</td>
                        <td>${e.category}</td>
                        <td>${e.price}</td>
                        <td>${e.quantity}</td>
                        <td>${e.retailer}</td>
                        <td>
                            <a href="/products/${e._id}/edit" class="btn btn-primary">Edit</a>
                            <button class="btn btn-danger" onclick="deleteProduct('${e._id}')">Delete</button>
                        </td>
                    `,n.appendChild(t))}),dataTableInstance?dataTableInstance.draw():dataTableInstance=new DataTable("#productsTable",{paging:!0,searching:!0,ordering:!0,info:!0,pageLength:8})}).catch(e=>console.error("Error loading products:",e))}async function deleteProduct(e){if(confirm("Are you sure you want to delete this product?"))try{(await fetch(`/products/${e}/delete`,{method:"DELETE"})).ok?(alert("Product deleted successfully"),fetchProducts()):alert("Error deleting product")}catch(e){console.error("Error:",e),alert("Error deleting product")}}function fetchOrders(){fetch("/admin/orders").then(e=>e.json()).then(e=>{let i=document.getElementById("ordersTableBody");i.innerHTML="",Array.isArray(e)?(e.forEach(e=>{var t=e.userId?`${e.shippingAddress.street}, ${e.shippingAddress.city}, `+e.shippingAddress.country:"N/A",n=e.userId&&e.userId._id?e.userId.fullName:"N/A",o=e.totalAmount,a=e.status,r=new Date(e.orderedAt).toLocaleDateString(),d=e.shippedAt?new Date(e.shippedAt).toLocaleDateString():"N/A",s=e.deliveredAt?new Date(e.deliveredAt).toLocaleDateString():"N/A";let c="";e.orderItems.forEach(e=>{var t=e.productId?e.productId.name:"Unknown Product",n=e.price,e=e.quantity;c+=`<p>${t} (x${e}) - $${n}</p>`});e=document.createElement("tr");e.innerHTML=`
                        <td>${n}</td>
                        <td>${t}</td>
                        <td>${c}</td>
                        <td>$${o}</td>
                        <td>${a}</td>
                        <td>${r}</td>
                        <td>${d}</td>
                        <td>${s}</td>
                    `,i.appendChild(e)}),$.fn.dataTable.isDataTable("#ordersTable")&&$("#ordersTable").DataTable().destroy(),new DataTable("#ordersTable",{paging:!0,searching:!0,ordering:!0,info:!0,pageLength:8})):console.error("Expected an array of orders, but got:",e)}).catch(e=>console.error("Error loading orders:",e))}async function updateCartCount(){try{var e,t=await(await fetch("/cart/items")).json();t.success&&(e=t.cartItems.reduce((e,t)=>e+t.quantity,0),document.querySelector(".cart-count").textContent=e)}catch(e){console.error("Error updating cart count:",e)}}function adminNav(e,t){for(var n,o=document.getElementsByClassName("tabcontent"),a=0;a<o.length;a++)o[a].style.display="none";for(n=document.getElementsByClassName("tablinks"),tablist=document.getElementsByClassName("sidenav-items")[0].getElementsByTagName("li"),a=0;a<n.length;a++)n[a].classList.remove("active");for(a=0;a<tablist.length;a++)tablist[a].classList.remove("active");document.getElementById(t).style.display="block",e.currentTarget.classList.add("active"),e.currentTarget.closest("li").classList.add("active")}passwordUpdateForm?.addEventListener("submit",async t=>{t.preventDefault();var t=document.getElementById("currentPassword").value,e=document.getElementById("newPassword").value;try{var n=await(await fetch("/update-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:t,newPassword:e})})).json(),o=document.querySelector(".status-message");n.success?(o.textContent=n.message,o.style.color="green",document.getElementById("passwordForm").reset()):(o.textContent=n.message||"An error occurred. Please try again.",o.style.color="red"),o.style.display="block"}catch(e){console.error("Error:",e);t=document.querySelector(".status-message");t.textContent="Something went wrong. Please try again.",t.style.color="red",t.style.display="block"}}),window.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("authentication");var t=document.getElementById("register"),n=document.getElementById("login"),o=document.getElementById("logout"),a=document.getElementById("manageProduct"),r=document.getElementById("viewOrder"),d=document.getElementById("forgotPassword"),s=document.getElementById("back-to-sign-in"),c=document.getElementById("footer"),i=document.getElementById("toast__success"),l=document.getElementById("toast_error");let u=document.getElementById("userDropdownButton"),m=document.getElementById("userInfoPopup");document.getElementById("year").textContent=(new Date).getFullYear(),window.addEventListener("load",()=>{let e=document.querySelector(".loader-content");e?(document.body.style.overflow="hidden",setTimeout(()=>{e.style.display="none",document.body.style.overflow="auto"},2e3)):document.body.style.overflow="auto"}),null===i&&null===l||(i?M.toast({html:i.getAttribute("data-message"),classes:"toast toast__success",displayLength:4e3}):M.toast({html:l.getAttribute("data-message"),classes:"toast toast__error",displayLength:4e3}));i=window.location.pathname;"/"!==i&&"/dashboard"!==i||(c.style.display="none"),"/dashboard"===i&&(a.addEventListener("click",fetchProducts),r.addEventListener("click",fetchOrders)),t?.addEventListener("click",()=>{e.classList.add("active")}),n?.addEventListener("click",()=>{e.classList.remove("active")}),o?.addEventListener("click",()=>{fetch("/logout",{method:"POST",credentials:"include"}).then(e=>{e.ok&&(window.location.href="/")}).catch(e=>{console.error("Error logging out:",e)})}),d?.addEventListener("click",e=>{e.preventDefault(),document.getElementById("sign-in-form").style.display="none",document.getElementById("forgot-password-container").style.display="block"}),s?.addEventListener("click",e=>{e.preventDefault(),document.getElementById("sign-in-form").style.display="block",document.getElementById("forgot-password-container").style.display="none"}),u&&m&&document.addEventListener("click",e=>{e.target===u?(e.preventDefault(),m.classList.toggle("active")):m.contains(e.target)||m.classList.remove("active")})});let notifications=[];function updateNotifications(e){console.log("Updating notifications with:",e),notifications.unshift(e);var t=document.querySelector(".notification-count"),t=(t&&(t.textContent=notifications.length),document.getElementById("notifications-dropdown"));t&&(t.innerHTML=notifications.map(e=>`
                    <li>
                        <a href="#!" class="notification-item">
                            <span class="notification-message">${e.message}</span>
                            <span class="notification-time">${new Date(e.timestamp).toLocaleTimeString()}</span>
                        </a>
                    </li>
                `).join("")),M&&M.toast&&M.toast({html:e.message})}let socket=io();socket.on("connect",()=>{console.log("Connected to socket server")}),socket.on("connect_error",e=>{console.error("Socket connection error:",e)}),socket.on("notification",e=>{console.log("Received notification:",e),updateNotifications(e)});